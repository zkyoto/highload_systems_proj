name: Build and Test Docker Images

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Images and Tags
        id: vars
        run: |
          echo "IMAGE_TAG=${GITHUB_SHA::7}-${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV
          echo "::set-output name=image_tag::${GITHUB_SHA::7}-${GITHUB_RUN_NUMBER}"
          images=("api-gateway" "authorizator" "passport" "interviewing-service/candidates" "interviewing-service/feedbacks" "interviewing-service/interviews" "interviewing-service/interviewers" "interviewing-service/interview-results")
          echo "IMAGES=${images[*]}" >> $GITHUB_ENV

      - name: Build and push Docker images
        run: |
          cat <<EOF > key.json
          ${{ secrets.YC_SA_KEYS }}
          EOF

          cat key.json
          cat key.json | docker login --username json_key --password-stdin cr.yandex;
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash;
          /root/yandex-cloud/bin/yc config profile create sa-profile;
          /root/yandex-cloud/bin/yc config set service-account-key /tmp/key.json;
          /root/yandex-cloud/bin/yc config set folder-id b1gpc0hok0hnsr7oqg49;

          /root/yandex-cloud/bin/yc managed-kubernetes cluster get-credentials zkyoto-cluster-name --external;


#          docker build -t kyoto67/highload/base:${{ env.IMAGE_TAG }} .
#
#          IFS=' ' read -r -a images <<< "${IMAGES}"
#
#          for image in "${images[@]}"; do
#            echo "Building and pushing image: $image with tag: ${{ env.IMAGE_TAG }}"
#            docker build --build-arg BASE_IMAGE_VERSION=${{ env.IMAGE_TAG }} -t cr.yandex/crpc3a58ds50f3fj3c80/$image:${{ env.IMAGE_TAG }} ./apps/$image
#            docker push cr.yandex/crpc3a58ds50f3fj3c80/$image:${{ env.IMAGE_TAG }}
#          done
#
#
#          FILE="k8s/deployments/api-gateway.yaml"
#
#          sed -i 's|image: %{IMAGE_TAG}|image: cr.yandex/crpc3a58ds50f3fj3c80/$image:${{ env.IMAGE_TAG }}|' "$FILE"
#
#          kubectl apply $FILE